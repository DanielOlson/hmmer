top_srcdir     = @top_srcdir@
srcdir         = @srcdir@
VPATH          = @srcdir@
SHELL          = /bin/sh

# Installation targets
#
prefix      = @prefix@
exec_prefix = @exec_prefix@
datarootdir = @datarootdir@
bindir      = @bindir@
libdir      = @libdir@
includedir  = @includedir@
mandir      = @mandir@
docdir      = @docdir@
pdfdir      = @pdfdir@
mandir      = @mandir@
man1dir     = ${mandir}/man1
man1ext     = .1

HMMER_VERSION   =  @HMMER_VERSION@
HMMER_DATE      = "@HMMER_DATE@"
HMMER_COPYRIGHT = "@HMMER_COPYRIGHT@"

INSTALL       = @INSTALL@
RMAN          = rman
RMANPROCESS   = ${top_srcdir}/easel/devkit/rmanprocess.pl

MANPAGES = \
	../man/alimask.man     \
	../man/hmmalign.man    \
	../man/hmmbuild.man    \
	../man/hmmconvert.man  \
	../man/hmmemit.man     \
	../man/hmmfetch.man    \
	../man/hmmlogo.man     \
	../man/hmmpgmd.man     \
	../man/hmmpress.man    \
	../man/hmmscan.man     \
	../man/hmmsearch.man   \
	../man/hmmsim.man      \
	../man/hmmstat.man     \
	../man/jackhmmer.man   \
	../man/makehmmerdb.man \
	../man/nhmmer.man      \
	../man/nhmmscan.man    \
	../man/phmmer.man      

TEXFILES =\
	ack.tex          \
	copyright.tex    \
	formats.tex      \
	glossary.tex     \
	install.tex      \
	introduction.tex \
	macros.tex       \
	main.tex         \
	more.tex         \
	pipeline.tex     \
	tabular.tex      \
	titlepage.tex    \
	tutorial.tex

.PHONY: pdf install uninstall clean distclean TAGS

pdf:    Userguide.pdf

Userguide.pdf: symlinks.stamp manpages.tex ${MANPAGES} ${TEXFILES}
	@for prog in xelatex bibtex; do \
	  command -v $$prog >/dev/null 2>&1 || { echo >&2 "The $$prog program is required to build the Userguide, but it's not installed. Aborting."; exit 1; } \
	done
	@echo "     LATEX Userguide.pdf  (see latex.log for output)"
	@xelatex main   > latex.log 2>&1 
	@bibtex main   >> latex.log 2>&1 
	@xelatex main  >> latex.log 2>&1 
	@xelatex main  >> latex.log 2>&1 
	@mv main.pdf Userguide.pdf

symlinks.stamp:
	@if test "x${srcdir}" != "x."; then \
	   for texfile in ${TEXFILES}; do \
	      if ! (test -e $$texfile); then \
	         ln -s ${srcdir}/$$texfile . ;\
	      fi ;\
	   done ;\
	fi
	@echo "symlinks created:\c" > $@
	@date >> $@

# manpages: convert man pages to LaTeX chapter in User Guide.
#    uses PolyglotMan 3.2 "rman", and rmanprocess.pl script in easel's devkit
manpages.tex: ${MANPAGES}
	@command -v ${RMAN} >/dev/null 2>&1 || { echo >&2 "The ${RMAN} program is required to build the Userguide, but it's not installed. Aborting."; exit 1; }
	@echo "%% This chapter automatically generated. Do not edit." > manpages.tex
	@echo "\section{Manual pages}" >> manpages.tex 
	@for file in ${MANPAGES}; do\
	   ${RMAN} -f LaTeX2e $$file 2>/dev/null | ${RMANPROCESS} >> manpages.tex ;\
	done

install:
	${INSTALL} -m 0644 Userguide.pdf ${DESTDIR}${pdfdir}

uninstall:
	-rm -f  ${DESTDIR}${pdfdir}/Userguide.pdf 

clean:
	-rm -f latex.log
	-rm -f main.aux main.bbl main.blg main.log main.toc main.brf main.out x.log *~
ifndef V
	@echo '     ' CLEAN userguide
endif


distclean: clean
	if test "x${srcdir}" != "x."; then \
	   for texfile in ${TEXFILES}; do \
	      rm -f $$texfile ;\
	   done ;\
	fi
	-rm -f symlinks.stamp
	-rm -f titlepage.tex copyright.tex manpages.tex
	-rm -f Userguide.pdf
	-rm -f Makefile

